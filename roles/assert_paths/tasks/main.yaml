- name: Stat required paths
  stat:
    path: "{{ item.path }}"
    follow: false
  loop: "{{ required_paths }}"
  register: path_stats
  changed_when: false

- name: Build list of paths that fail checks
  set_fact:
    assert_paths_bad: "{{ (assert_paths_bad | default([])) + [r] }}"
  loop: "{{ path_stats.results }}"
  loop_control:
    loop_var: r
  when: >
    (not (r.stat.exists | bool))
    or (r.item.type == 'file' and not (r.stat.isreg | bool))
    or (r.item.type == 'directory' and not (r.stat.isdir | bool))
    or (r.item.owner is defined and r.stat.pw_name != r.item.owner)
    or (r.item.group is defined and r.stat.gr_name != r.item.group)
    or (r.item.mode is defined and r.stat.mode != r.item.mode)
  changed_when: false

- name: Assert required paths exist with correct type and permissions
  assert:
    that:
      - (assert_paths_bad | default([]) | length) == 0
    fail_msg: >-
      Required paths check failed.
      Bad entries: {{
        (assert_paths_bad | default([]))
        | map(attribute='item')
        | list
      }}