- name: Assert required paths exist with correct type and permissions
  stat:
    path: "{{ item.path }}"
    follow: false
  loop: "{{ required_paths }}"
  register: path_stats
  changed_when: false
  failed_when: >
    path_stats.results
    | selectattr('stat.exists', 'equalto', false)
    | list
    | length > 0
    or
    path_stats.results
    | selectattr('item.type', 'equalto', 'file')
    | selectattr('stat.isreg', 'equalto', false)
    | list
    | length > 0
    or
    path_stats.results
    | selectattr('item.type', 'equalto', 'directory')
    | selectattr('stat.isdir', 'equalto', false)
    | list
    | length > 0
    or
    path_stats.results
    | selectattr('item.owner', 'defined')
    | selectattr('stat.pw_name', 'ne', attribute='item.owner')
    | list
    | length > 0
    or
    path_stats.results
    | selectattr('item.group', 'defined')
    | selectattr('stat.gr_name', 'ne', attribute='item.group')
    | list
    | length > 0
    or
    path_stats.results
    | selectattr('item.mode', 'defined')
    | selectattr('stat.mode', 'ne', attribute='item.mode')
    | list
    | length > 0
