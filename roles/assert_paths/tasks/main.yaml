- name: Stat required paths
  stat:
    path: "{{ item.path }}"
    follow: false
  loop: "{{ required_paths }}"
  register: path_stats
  changed_when: false

- name: Assert required paths exist with correct type and permissions
  assert:
    that:
      - (path_stats.results | selectattr('stat.exists', 'equalto', false) | list | length) == 0
      - (path_stats.results | selectattr('item.type', 'equalto', 'file') | selectattr('stat.isreg', 'equalto', false) | list | length) == 0
      - (path_stats.results | selectattr('item.type', 'equalto', 'directory') | selectattr('stat.isdir', 'equalto', false) | list | length) == 0
      - (path_stats.results | selectattr('item.owner', 'defined') | rejectattr('stat.pw_name', 'equalto', item.owner) | list | length) == 0
      - (path_stats.results | selectattr('item.group', 'defined') | rejectattr('stat.gr_name', 'equalto', item.group) | list | length) == 0
      - (path_stats.results | selectattr('item.mode', 'defined') | rejectattr('stat.mode', 'equalto', item.mode) | list | length) == 0
    fail_msg: >-
      One or more required paths are missing or have wrong type/ownership/mode.
      Details: {{ path_stats.results }}