###############################################################################
# Enable TLS verification in Consul (client-side)
#
# Preconditions:
#   - Consul is installed and running
#   - Bootstrap CA certificate has been distributed:
#       * {{ consul_tls_dir }}/ca.pem
#
# Guarantees:
#   - Consul verifies TLS connections using the bootstrap CA
#   - No Consul server TLS is enabled yet
#   - Consul is restarted explicitly and validated
###############################################################################

- name: Reconfigure and restart Consul to use TLS
  hosts: vault
  become: true
  gather_facts: false
  ###############################################################################
  # Pre-flight checks (defensive)
  ###############################################################################
  pre_tasks:
  - name: Assert Consul TLS inputs
    include_role:
      name: assert_paths
    vars:
      required_paths:
      - path: "{{ consul_ca_cert_path }}"
        type: file
        owner: "{{ consul_user }}"
        group: "{{ consul_group }}"
        mode: "0644"

      - path: "{{ consul_server_key_path }}"
        type: file
        owner: "{{ consul_user }}"
        group: "{{ consul_group }}"
        mode: "0600"

      - path: "{{ consul_server_cert_path }}"
        type: file
        owner: "{{ consul_user }}"
        group: "{{ consul_group }}"
        mode: "0640"

      - path: "{{ consul_tls_dir }}"
        type: directory
        owner: "{{ consul_user }}"
        group: "{{ consul_group }}"
        mode: "0750"
  tasks:
  - name: Stop Consul
    systemd:
      name: consul
      state: stopped

  - name: Enable Consul TLS mode
    set_fact:
      consul_tls_enabled: true
  ###############################################################################
  # Reconfigure Consul for TLS verification
  ###############################################################################

  - name: Re-render Consul configuration with TLS verification enabled
    import_role:
      name: consul
      tasks_from: configure

  ###############################################################################
  # Restart Consul explicitly
  ###############################################################################

  - name: Start Consul
    systemd:
      name: consul
      state: started

###############################################################################
# Post-flight sanity check
###############################################################################

- name: Verify Consul service is running
  systemd:
    name: consul
    state: started
  changed_when: false
