---
###############################################################################
# Copy TLS artifacts generated on primary Bastion host to Consul hosts
#
# - CA certificate
# - Consul server certificate + private key
#
###############################################################################

- name: Ensure Consul TLS directory exists
  file:
    path: "{{ consul_ca_cert_path | dirname }}"
    state: directory
    owner: consul
    group: consul
    mode: "0750"

- name: Copy CA certificate to Consul from Bastion
  copy:
  # we run Ansible on Bastion, so src is local path on Bastion (controller), dest is path on Consul
    src: "{{ bastion_ca_cert_path }}"
    dest: "{{ consul_ca_cert_path }}"
    owner: consul
    group: consul
    mode: "0644"

###############################################################################
# Distribute Consul server certificate & key
###############################################################################

- name: Copy Consul TLS certificate from Bastion to Consul
  copy:
  # we run Ansible on Bastion, so src is local path on Bastion (controller), dest is path on Consul
    src: "{{ bastion_tmp_tls_dir_for_consul }}/{{ inventory_hostname }}/{{consul_server_cert_file}}"
    dest: "{{ consul_server_cert_path }}"
    owner: consul
    group: consul
    mode: "0644"

- name: Copy Consul TLS private key from Bastion to Consul
  copy:
  # we run Ansible on Bastion, so src is local path on Bastion (controller), dest is path on Consul
    src: "{{ bastion_tmp_tls_dir_for_consul }}/{{ inventory_hostname }}/{{consul_server_key_file}}"
    dest: "{{ consul_server_key_path }}"
    owner: consul
    group: consul
    mode: "0600"

###############################################################################
# Sanity checks
###############################################################################

- name: Assert required TLS files exist
  include_role:
    name: assert_paths
  vars:
    required_paths:
    - path: "{{ consul_server_cert_path }}"
      type: file
      owner: consul
      group: consul
      mode: "0644"
    - path: "{{ consul_server_key_path }}"
      type: file
      owner: consul
      group: consul
      mode: "0600"
    - path: "{{ consul_ca_cert_path }}"
      type: file
      owner: consul
      group: consul
      mode: "0644"
