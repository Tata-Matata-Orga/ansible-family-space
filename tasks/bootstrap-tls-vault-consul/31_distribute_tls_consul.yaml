---
###############################################################################
# Copy TLS artifacts generated on primary Bastion host to Consul hosts
#
# - CA certificate
# - Consul server certificate + private key
#
###############################################################################

- name: Ensure Consul TLS directory exists
  file:
    path: "{{ consul_tls_dir }}"
    state: directory
    owner: consul
    group: consul
    mode: "0750"

- name: Copy CA certificate to Consul
  copy:
    src: "{{ bastion_ca_cert_path }}"
    dest: "{{ consul_ca_cert_path }}"
    owner: root
    group: root
    mode: "0644"
    remote_src: yes
  delegate_to: bastion_primary

###############################################################################
# Distribute Consul server certificate & key
###############################################################################

- name: Copy Consul TLS certificate
  copy:
    src: "{{ bastion_tmp_tls_dir_for_consul }}/{{ inventory_hostname }}/{{consul_server_cert_file}}"
    dest: "{{ consul_server_cert_path }}"
    owner: consul
    group: consul
    mode: "0644"
    remote_src: yes
  delegate_to: bastion_primary

- name: Copy Consul TLS private key
  copy:
    src: "{{ bastion_tmp_tls_dir_for_consul }}/{{ inventory_hostname }}/{{consul_server_key_file}}"
    dest: "{{ consul_server_key_path }}"
    owner: consul
    group: consul
    mode: "0600"
    remote_src: yes
  delegate_to: bastion_primary

###############################################################################
# Sanity checks
###############################################################################

- name: Assert required TLS files exist
  include_role:
    name: assert_paths
  vars:
    required_paths:
    - path: "{{ consul_server_cert_path }}"
      type: file
      owner: root
      group: root
      mode: "0644"
    - path: "{{ consul_server_key_path }}"
      type: file
      owner: root
      group: root
      mode: "0600"
    - path: "{{ consul_ca_cert_path }}"
      type: file
      owner: root
      group: root
      mode: "0644"
