###############################################################################
# Issue Consul server TLS certificate on Bastion for Consul server to authenticate to clients
#
###############################################################################

- name: Ensure TLS directories for Consul material exist on Bastion (tmp root, consul root, consul host)
  file:
    path: "{{ item.path }}"
    state: directory
    owner: root
    group: root
    mode: "{{ item.mode | default('0755') }}"
  loop:
    - path: "{{ bastion_tmp_tls_dir }}"
      mode: "0755"
    - path: "{{ bastion_tmp_tls_dir_for_consul }}"
      mode: "0755"
    - path: "{{ bastion_tmp_tls_dir_for_consul }}/{{ consul_host }}"
      mode: "0755"


###############################################################################
# Consul private key
###############################################################################

- name: Generate Consul TLS private key
  community.crypto.openssl_privatekey:
    path: "{{ bastion_tmp_tls_dir_for_consul }}/{{ consul_host }}/{{ consul_server_key_file }}"
    type: Ed25519
    owner: root
    group: root
    mode: "0600"

###############################################################################
# Build SAN list for Consul certificate
###############################################################################

- name: Build Consul certificate SANs
  set_fact:
    consul_tls_sans:
      - "DNS:{{ consul_host }}"
      - "DNS:{{ consul_service_name }}"
      - "IP:{{ hostvars[consul_host].ansible_host }}"
  changed_when: false

###############################################################################
# Certificate Signing Request (CSR)
###############################################################################

- name: Generate Consul TLS CSR
  community.crypto.openssl_csr:
    path: "{{ bastion_tmp_tls_dir_for_consul }}/{{ consul_host }}/consul.csr"
    privatekey_path: "{{ bastion_tmp_tls_dir_for_consul }}/{{ consul_host }}/{{ consul_server_key_file }}"
    common_name: "{{ consul_host }}"
    organization_name: "consul"
    subject_alt_name: "{{ consul_tls_sans }}"

###############################################################################
# Sign Consul certificate with bootstrap CA
###############################################################################

- name: Sign Consul TLS certificate with bootstrap CA
  community.crypto.x509_certificate:
    path: "{{ bastion_tmp_tls_dir_for_consul }}/{{ consul_host }}/{{ consul_server_cert_file }}"
    csr_path: "{{ bastion_tmp_tls_dir_for_consul }}/{{ consul_host }}/consul.csr"
    provider: ownca
    ownca_path: "{{ bastion_ca_cert_path }}"
    ownca_privatekey_path: "{{ bastion_ca_key_path }}"
    ownca_not_after: "+{{ bootstrap_ca_ttl_days }}d"
    owner: root
    group: root
    mode: "0644"

###############################################################################
# Sanity checks
###############################################################################

- name: Assert Consul server certificate and key were created
  include_role:
    name: assert_paths
  vars:
    required_paths:
      - path: "{{ bastion_tmp_tls_dir_for_consul }}/{{ consul_host }}/{{ consul_server_cert_file }}"
        type: file
        owner: root
        group: root
        mode: "0644"
      - path: "{{ bastion_tmp_tls_dir_for_consul }}/{{ consul_host }}/{{ consul_server_key_file }}"
        type: file
        owner: root
        group: root
        mode: "0600"
