###############################################################################
# Issue Consul server TLS certificate (Bastion only)
#
# Purpose:
#   - Generate Consul private key
#   - Create CSR with correct SANs
#   - Sign CSR using bootstrap TLS CA
#
# Outputs (per Consul host):
#   - consul.key
#   - consul.csr
#   - consul.pem
###############################################################################

###############################################################################
# Directory layout
###############################################################################

- name: Ensure Consul TLS directory exists (on Bastion)
  file:
    path: "{{ bootstrap_tls_dir }}/consul/{{ consul_host }}"
    state: directory
    owner: root
    group: root
    mode: "0700"


###############################################################################
# Consul private key
###############################################################################

- name: Generate Consul TLS private key
  community.crypto.openssl_privatekey:
    path: "{{ bootstrap_tls_dir }}/consul/{{ consul_host }}/consul.key"
    type: ed25519
    owner: root
    group: root
    mode: "0600"


###############################################################################
# Build SAN list for Consul certificate
###############################################################################

- name: Build Consul certificate SANs
  set_fact:
    consul_tls_sans:
      - "DNS:{{ consul_host }}"
      - "IP:{{ hostvars[consul_host].ansible_default_ipv4.address }}"
  changed_when: false


###############################################################################
# Certificate Signing Request (CSR)
###############################################################################

- name: Generate Consul TLS CSR
  community.crypto.openssl_csr:
    path: "{{ bootstrap_tls_dir }}/consul/{{ consul_host }}/consul.csr"
    privatekey_path: "{{ bootstrap_tls_dir }}/consul/{{ consul_host }}/consul.key"
    subject:
      common_name: "{{ consul_host }}"
      organization_name: "consul"
    subject_alt_name: "{{ consul_tls_sans }}"


###############################################################################
# Sign Consul certificate with bootstrap CA
###############################################################################

- name: Sign Consul TLS certificate with bootstrap CA
  community.crypto.openssl_certificate:
    path: "{{ bootstrap_tls_dir }}/consul/{{ consul_host }}/consul.pem"
    csr_path: "{{ bootstrap_tls_dir }}/consul/{{ consul_host }}/consul.csr"
    provider: ownca
    ownca_path: "{{ bootstrap_tls_dir }}/ca.pem"
    ownca_privatekey_path: "{{ bootstrap_tls_dir }}/ca.key"
    ownca_not_after: "+{{ bootstrap_ca_ttl_days }}d"


###############################################################################
# Sanity checks
###############################################################################

- name: Assert Consul TLS certificate was created
  stat:
    path: "{{ bootstrap_tls_dir }}/consul/{{ consul_host }}/consul.pem"
  register: consul_cert_stat
  changed_when: false


- name: Fail if Consul TLS certificate is missing
  fail:
    msg: >
      Consul TLS certificate was not created for {{ consul_host }}.
      Bootstrap TLS process cannot continue.
  when: not consul_cert_stat.stat.exists