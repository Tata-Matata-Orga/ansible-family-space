---
###############################################################################
# Issue Vault server TLS certificate on Bastion for Vault server to authenticate to its clients
#
###############################################################################


- name: Ensure Vault TLS directory exists (on Bastion)
  file:
    path: "{{ bastion_tmp_tls_dir_for_vault  }}/{{ vault_host }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

###############################################################################
# Vault private key
###############################################################################

- name: Generate Vault TLS private key
  community.crypto.openssl_privatekey:
    path: "{{ bastion_tmp_tls_dir_for_vault  }}/{{ vault_host }}/{{vault_server_key_file}}"
    type: Ed25519
    owner: root
    group: root
    mode: "0600"

###############################################################################
# Build SAN list for Vault certificate
###############################################################################

- name: Build Vault certificate SANs
  set_fact:
    vault_tls_sans:
    - "DNS:{{ vault_host }}"
    - "DNS:{{ vault_service_name }}"
    - "IP:{{ hostvars[vault_host].ansible_default_ipv4.address }}"
  changed_when: false

###############################################################################
# Certificate Signing Request (CSR)
###############################################################################

- name: Generate Vault TLS CSR
  community.crypto.openssl_csr:
    path: "{{ bastion_tmp_tls_dir_for_vault  }}/{{ vault_host }}/vault.csr"
    privatekey_path: "{{ bastion_tmp_tls_dir_for_vault  }}/{{ vault_host }}/{{vault_server_key_file}}"
    subject:
      common_name: "{{ vault_host }}"
      organization_name: "vault"
    subject_alt_name: "{{ vault_tls_sans }}"

###############################################################################
# Sign Vault certificate with bootstrap CA
###############################################################################

- name: Sign Vault TLS certificate with bootstrap CA
  community.crypto.openssl_certificate:
    path: "{{ bastion_tmp_tls_dir_for_vault  }}/{{ vault_host }}/{{vault_server_cert_file}}"
    csr_path: "{{ bastion_tmp_tls_dir_for_vault  }}/{{ vault_host }}/vault.csr"
    provider: ownca
    ownca_path: "{{ bastion_ca_cert_path }}"
    ownca_privatekey_path: "{{ bastion_ca_key_path }}"
    ownca_not_after: "+{{ bootstrap_ca_ttl_days }}d"

###############################################################################
# Sanity checks
###############################################################################

- name: Assert Vault TLS certificate was created
  include_role:
    name: assert_paths
  vars:
    requred_paths:
    - path: "{{ bastion_tmp_tls_dir_for_vault  }}/{{ vault_host }}/{{vault_server_cert_file}}"
      type: file
      owner: root
      group: root
      mode: "0644"
    - path: "{{ bastion_tmp_tls_dir_for_vault  }}/{{ vault_host }}/{{vault_server_key_file}}"
      type: file
      owner: root
      group: root
      mode: "0600"
