###############################################################################
# After generating client certificates for Bastion to auth to Consul and Vault on Bastion primary host,
# we need to distribute the TLS material to all Bastion hosts.
###############################################################################

###############################################################################
## CA cert from primary Bastion to all Bastion hosts
###############################################################################

- name: Ensure Bastion TLS directory exists
  file:
    path: "{{ bastion_tls_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Copy CA certificate from primary Bastion to this Bastion
  copy:
    src: "{{ bastion_ca_cert_path }}"
    dest: "{{ bastion_ca_cert_path }}"
    owner: root
    group: root
    mode: "0644"
    remote_src: yes
  delegate_to: bastion_primary

# Bastion to Consul auth certs
###############################################################################
######## USAGE ################################################################
# export CONSUL_CACERT={{ bastion_ca_cert_path }}
# export CONSUL_CLIENT_CERT={{ bastion_client_auth_to_consul_cert_path }}
# export CONSUL_CLIENT_KEY={{ bastion_client_auth_to_consul_key_path }}
###############################################################################

- name: Ensure TLS directory for Consul client certs exists on Bastion
  file:
    path: "{{ bastion_client_auth_to_consul_certs_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Copy Bastion client certificate from primary Bastion to this Bastion
  copy:
    src: "{{ bastion_tmp_tls_dir_for_consul_clients }}/{{ inventory_hostname }}/{{ consul_client_cert_file }}"
    dest: "{{ bastion_client_auth_to_consul_cert_path }}"
    owner: root
    group: root
    mode: "0644"
    remote_src: yes
  delegate_to: bastion_primary

- name: Copy Bastion client private key from primary Bastion to this Bastion
  copy:
    src: "{{ bastion_tmp_tls_dir_for_consul_clients }}/{{ inventory_hostname }}/{{ consul_client_key_file }}"
    dest: "{{ bastion_client_auth_to_consul_key_path }}"
    owner: root
    group: root
    mode: "0600"
    remote_src: yes
  delegate_to: bastion_primary

###############################################################################
#  Bastion â†’ Vault
###############################################################################

################ USAGE ########################################################
# export VAULT_ADDR=https://{{ vault_private_ip }}:{{ vault_api_port }}
# export VAULT_CACERT={{ bastion_ca_cert_path }}
# export VAULT_CLIENT_CERT={{ bastion_client_auth_to_vault_cert_path }}
# export VAULT_CLIENT_KEY={{ bastion_client_auth_to_vault_key_path }}
###############################################################################

- name: Ensure Bastion TLS directory exists
  file:
    path: "{{ bastion_client_auth_to_vault_certs_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Copy Bastion Vault client certificate
  copy:
    src: "{{ bastion_tmp_tls_dir_for_vault_clients }}/{{ inventory_hostname }}/{{ vault_client_cert_file }}"
    dest: "{{ bastion_client_auth_to_vault_cert_path }}"
    owner: root
    group: root
    mode: "0644"
    remote_src: yes
  delegate_to: bastion_primary

- name: Copy Bastion Vault client private key
  copy:
    src: "{{ bastion_tmp_tls_dir_for_vault_clients }}/{{ inventory_hostname }}/{{ vault_client_key_file }}"
    dest: "{{ bastion_client_auth_to_vault_key_path }}"
    owner: root
    group: root
    mode: "0600"
    remote_src: yes
  delegate_to: bastion_primary

###############################################################################
# Sanity checks
###############################################################################
- name: Assert required TLS files exist on Bastion
  include_role:
    name: assert_paths
  vars:
    requred_paths:
    - path: "{{ bastion_tls_dir }}"
      type: folder
      owner: root
      group: root
      mode: "0700"
    - path: "{{ bastion_ca_cert_path }}"
      type: file
      owner: root
      group: root
      mode: "0644"
    - path: "{{ bastion_client_auth_to_consul_certs_dir }}"
      type: folder
      owner: root
      group: root
      mode: "0700"
    - path: "{{ bastion_client_auth_to_consul_cert_path }}"
      type: file
      owner: root
      group: root
      mode: "0644"
    - path: "{{ bastion_client_auth_to_consul_key_path }}"
      type: file
      owner: root
      group: root
      mode: "0600"
    - path: "{{ bastion_client_auth_to_vault_certs_dir }}"
      type: folder
      owner: root
      group: root
      mode: "0700"
    - path: "{{ bastion_client_auth_to_vault_cert_path }}"
      type: file
      owner: root
      group: root
      mode: "0644"
    - path: "{{ bastion_client_auth_to_vault_key_path }}"
      type: file
      owner: root
      group: root
      mode: "0600"
