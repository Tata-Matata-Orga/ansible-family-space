###############################################################################
# Issue Bastion client certificate on Bastion primary server (to distribute later to each Bastion)
# For Bastion to authenticate to Vault API via mTLS as client
###############################################################################

- name: Ensure temp Bastion Vault client TLS directory exists on primary Bastion server
  file:
    path: "{{ bastion_tmp_tls_dir_for_vault_clients }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

###############################################################################
# Private key
###############################################################################

- name: Generate Bastion Vault client private key
  community.crypto.openssl_privatekey:
    path: "{{ bastion_tmp_tls_dir_for_vault_clients }}/{{ bastion_host }}/{{ vault_client_key_file }}"
    type: ed25519
    owner: root
    group: root
    mode: "0600"

###############################################################################
# SANs
###############################################################################

- name: Build Bastion Vault client SANs
  set_fact:
    bastion_vault_client_sans:
    - "DNS:bastion"
  changed_when: false

###############################################################################
# CSR
###############################################################################

- name: Generate client TLS CSR
  community.crypto.openssl_csr:
    path: "{{ bastion_tmp_tls_dir_for_vault_clients }}/{{ bastion_host }}/client.csr"
    privatekey_path: "{{ bastion_tmp_tls_dir_for_vault_clients }}/{{ bastion_host }}/{{ vault_client_key_file }}"
    subject:
      common_name: "{{ client_name }}"
      organization_name: "consul-client"
    subject_alt_name: "{{ client_tls_sans }}"

###############################################################################
# Sign certificate
###############################################################################

- name: Sign client TLS certificate with bootstrap CA
  community.crypto.openssl_certificate:
    path: "{{ bastion_tmp_tls_dir_for_vault_clients }}/{{ bastion_host }}/{{ vault_client_cert_file }}"
    csr_path: "{{ bastion_tmp_tls_dir_for_vault_clients }}/{{ bastion_host }}/client.csr"
    provider: ownca
    ownca_path: "{{ bastion_ca_cert_path }}"
    ownca_privatekey_path: "{{ bastion_ca_key_path }}"
    ownca_not_after: "+{{ bootstrap_ca_ttl_days }}d"

###############################################################################
# Sanity checks
###############################################################################

- name: Assert required TLS files exist
  include_role:
    name: assert_paths
  vars:
    requred_paths:
    - path: "{{ bastion_tmp_tls_dir_for_vault_clients }}/{{ bastion_host }}/{{ vault_client_cert_file }}"
      type: file
      owner: root
      group: root
      mode: "0644"
    - path: "{{ bastion_tmp_tls_dir_for_vault_clients }}/{{ bastion_host }}/{{ vault_client_key_file }}"
      type: file
      owner: root
      group: root
      mode: "0600"
