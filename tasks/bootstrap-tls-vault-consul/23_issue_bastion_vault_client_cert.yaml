###############################################################################
# Issue Bastion client certificate on Bastion primary server (to distribute later to each Bastion)
# For Bastion to authenticate to Vault API via mTLS as client
#
###############################################################################


- name: Ensure Bastion Vault client TLS directory exists on Bastion
  file:
    path: "{{ bootstrap_vault_client_certs_folder_on_bastion }}"
    state: directory
    owner: root
    group: root
    mode: "0700"


###############################################################################
# Private key
###############################################################################

- name: Generate Bastion Vault client private key
  community.crypto.openssl_privatekey:
    path: "{{ bootstrap_vault_client_key_path_on_bastion }}"
    type: ed25519
    owner: root
    group: root
    mode: "0600"


###############################################################################
# SANs
###############################################################################

- name: Build Bastion Vault client SANs
  set_fact:
    bastion_vault_client_sans:
      - "DNS:bastion"
  changed_when: false


###############################################################################
# CSR
###############################################################################

- name: Generate Bastion Vault client CSR
  community.crypto.openssl_csr:
    path: "{{ bootstrap_vault_client_certs_folder_on_bastion }}/client.csr"
    privatekey_path: "{{ bootstrap_vault_client_key_path_on_bastion }}"
    subject:
      common_name: "bastion-vault-client"
      organization_name: "vault-client"
    subject_alt_name: "{{ bastion_vault_client_sans }}"


###############################################################################
# Sign certificate
###############################################################################

- name: Sign Bastion Vault client certificate with bootstrap CA
  community.crypto.openssl_certificate:
    path: "{{ bootstrap_vault_client_cert_path_on_bastion }}"
    csr_path: "{{ bootstrap_vault_client_certs_folder_on_bastion }}/client.csr"
    provider: ownca
    ownca_path: "{{ ca_cert_path_on_bastion }}"
    ownca_privatekey_path: "{{ ca_cert_key_on_bastion }}"
    ownca_not_after: "+{{ bootstrap_ca_ttl_days }}d"


###############################################################################
# Sanity checks
###############################################################################

- name: Assert required TLS files exist
  stat:
    path: "{{ item }}"
  loop:
     - "{{ bootstrap_vault_client_cert_path_on_bastion }}"
     - "{{ bootstrap_vault_client_key_path_on_bastion }}"
  register: tls_files
  changed_when: false
  failed_when: not tls_files.stat.exists