###############################################################################
# Issue client TLS certificates on Bastion for Consul clients to authenticate to Consul servers
#
# Clients:
#   - Vault
#   - Bastion
###############################################################################

- name: Ensure client TLS directory exists (on Bastion)
  file:
    path: "{{ bootstrap_tls_dir }}/clients/{{ client_name }}"
    state: directory
    owner: root
    group: root
    mode: "0700"


###############################################################################
# Client private key
###############################################################################

- name: Generate client TLS private key
  community.crypto.openssl_privatekey:
    path: "{{ bootstrap_tls_dir }}/clients/{{ client_name }}/client.key"
    type: ed25519
    owner: root
    group: root
    mode: "0600"


###############################################################################
# Build SAN list
###############################################################################

- name: Build client certificate SANs
  set_fact:
    client_tls_sans:
      - "DNS:{{ client_name }}"
  changed_when: false


###############################################################################
# CSR
###############################################################################

- name: Generate client TLS CSR
  community.crypto.openssl_csr:
    path: "{{ bootstrap_tls_dir }}/clients/{{ client_name }}/client.csr"
    privatekey_path: "{{ bootstrap_tls_dir }}/clients/{{ client_name }}/client.key"
    subject:
      common_name: "{{ client_name }}"
      organization_name: "consul-client"
    subject_alt_name: "{{ client_tls_sans }}"


###############################################################################
# Sign client certificate
###############################################################################

- name: Sign client TLS certificate with bootstrap CA
  community.crypto.openssl_certificate:
    path: "{{ bootstrap_tls_dir }}/clients/{{ client_name }}/client.pem"
    csr_path: "{{ bootstrap_tls_dir }}/clients/{{ client_name }}/client.csr"
    provider: ownca
    ownca_path: "{{ bootstrap_tls_dir }}/ca.pem"
    ownca_privatekey_path: "{{ bootstrap_tls_dir }}/ca.key"
    ownca_not_after: "+{{ bootstrap_ca_ttl_days }}d"


###############################################################################
# Sanity checks
###############################################################################

- name: Assert client TLS certificate was created
  stat:
    path: "{{ bootstrap_tls_dir }}/clients/{{ client_name }}/client.pem"
  register: client_cert_stat
  changed_when: false

- name: Fail if client TLS certificate missing
  fail:
    msg: >
      Client TLS certificate was not created for {{ client_name }}.
  when: not client_cert_stat.stat.exists