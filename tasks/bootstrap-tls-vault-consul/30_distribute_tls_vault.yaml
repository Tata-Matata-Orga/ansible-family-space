---
###############################################################################
# Copy TLS artifacts generated on primary Bastion host to Vault hosts
#
# - CA certificate
# - Vault server certificate + private key
# - Vault client certificate + private key for Consul mTLS
###############################################################################

###############################################################################
# TLS directories on target hosts
###############################################################################

- name: Ensure Vault TLS directory exists
  file:
    path: "{{ vault_ca_cert_path | dirname }}"
    state: directory
    owner: vault
    group: vault
    mode: "0750"

###############################################################################
# Distribute CA certificate from primary Bastion to Vault
###############################################################################

- name: Copy CA certificate from Bastion to Vault
  copy:
    # we run Ansible on Bastion, so src is local path on Bastion (controller), dest is path on Vault
    src: "{{ bastion_ca_cert_path }}"
    dest: "{{ vault_ca_cert_path}}"
    owner: vault
    group: vault
    mode: "0644"

###############################################################################
# Distribute Vault server certificate & key  from primary Bastion to Vault
###############################################################################

- name: Copy Vault TLS certificate from Bastion to Vault
  copy:
  # we run Ansible on Bastion, so src is local path on Bastion (controller), dest is path on Vault
    src: "{{ bastion_tmp_tls_dir_for_vault }}/{{ inventory_hostname }}/{{vault_server_cert_file}}"
    dest: "{{ vault_server_cert_path }}"
    owner: vault
    group: vault
    mode: "0644"

- name: Copy Vault TLS private key from Bastion to Vault
  copy:
  # we run Ansible on Bastion, so src is local path on Bastion (controller), dest is path on Vault
    src: "{{ bastion_tmp_tls_dir_for_vault }}/{{ inventory_hostname }}/{{vault_server_key_file}}"
    dest: "{{ vault_server_key_path }}"
    owner: vault
    group: vault
    mode: "0600"

###############################################################################
# Distribute Vault client certificate & key (used for auth to Consul)  from primary Bastion to Vault
###############################################################################

- name: Ensure Vault directory for Consul client certs exists
  file:
    path: "{{ vault_client_auth_to_consul_cert_path | dirname }}"
    state: directory
    owner: vault
    group: vault
    mode: "0750"

- name: Copy Vault client certificate generated for auth to Consul from Bastion to Vault
  copy:
  # we run Ansible on Bastion, so src is local path on Bastion (controller), dest is path on Vault
    src: "{{ bastion_tmp_tls_dir_for_consul_clients }}/{{ inventory_hostname }}/{{consul_client_cert_file}}"
    dest: "{{ vault_client_auth_to_consul_cert_path }}"
    owner: vault
    group: vault
    mode: "0644"

- name: Copy Vault client private key
  copy:
  # we run Ansible on Bastion, so src is local path on Bastion (controller), dest is path on Vault
    src: "{{ bastion_tmp_tls_dir_for_consul_clients }}/{{ inventory_hostname }}/{{consul_client_key_file}}"
    dest: "{{ vault_client_auth_to_consul_key_path }}"
    owner: vault
    group: vault
    mode: "0600"

###############################################################################
# Sanity checks on Vault
###############################################################################

- name: Assert required TLS files exist
  include_role:
    name: assert_paths
  vars:
    required_paths:
    - path: "{{ vault_ca_cert_path }}"
      type: file
      owner: vault
      group: vault
      mode: "0644"
    - path: "{{ vault_server_cert_path }}"
      type: file
      owner: vault
      group: vault
      mode: "0644"
    - path: "{{ vault_server_key_path }}"
      type: file
      owner: vault
      group: vault
      mode: "0600"
    - path: "{{ vault_client_auth_to_consul_cert_path }}"
      type: file
      owner: vault
      group: vault
      mode: "0644"
    - path: "{{ vault_client_auth_to_consul_key_path }}"
      type: file
      owner: vault
      group: vault
      mode: "0600"
