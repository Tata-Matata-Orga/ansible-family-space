---
###############################################################################
# Copy TLS artifacts generated on primary Bastion host to Vault hosts
#
# - CA certificate
# - Vault server certificate + private key
# - Vault client certificate + private key for Consul mTLS
###############################################################################

###############################################################################
# TLS directories on target hosts
###############################################################################

- name: Ensure Vault TLS directory exists
  file:
    path: "{{ vault_tls_dir }}"
    state: directory
    owner: vault
    group: vault
    mode: "0750"


###############################################################################
# Distribute CA certificate from primary Bastion to Vault
###############################################################################
- name: Copy CA certificate to Vault
  copy:
    src: "{{ ca_cert_path_on_bastion }}"
    dest: "{{ vault_ca_cert_path}}"
    owner: root
    group: root
    mode: "0644"
    remote_src: yes # The source file lives on the delegated host, not the target
  delegate_to: "{{ bastion_primary_host }}"


###############################################################################
# Distribute Vault server certificate & key  from primary Bastion to Vault
###############################################################################

- name: Copy Vault TLS certificate
  copy:
    src: "{{ bootstrap_tls_dir }}/vault/{{ inventory_hostname }}/{{vault_server_cert_file}}"
    dest: "{{ vault_server_cert_path }}"
    owner: vault
    group: vault
    mode: "0644"
    remote_src: yes
  delegate_to: "{{ bastion_primary_host }}"

- name: Copy Vault TLS private key
  copy:
    src: "{{ bootstrap_tls_dir }}/vault/{{ inventory_hostname }}/{{vault_server_key_file}}"
    dest: "{{ vault_server_key_path }}"
    owner: vault
    group: vault
    mode: "0600"
    remote_src: yes
  delegate_to: "{{ bastion_primary_host }}"

###############################################################################
# Distribute Vault client certificate & key (used for Consul mTLS)  from primary Bastion to Vault
###############################################################################

- name: Copy Vault client certificate generated for Consul mTLS from Bastion to Vault
  copy:
    src: "{{ bootstrap_tls_dir }}/{{ consul_client_cert_dir }}/{{ inventory_hostname }}/{{consul_client_cert_file}}"
    dest: "{{ vault_client_cert_path_for_consul }}"
    owner: vault
    group: vault
    mode: "0644"
    remote_src: yes
  delegate_to: "{{ bastion_primary_host }}"


- name: Copy Vault client private key
  copy:
    src: "{{ bootstrap_tls_dir }}/{{ consul_client_cert_dir }}/{{ inventory_hostname }}/{{consul_client_key_file}}"
    dest: "{{ vault_client_key_path_for_consul }}"
    owner: vault
    group: vault
    mode: "0600"
    remote_src: yes
  delegate_to: "{{ bastion_primary_host }}"

###############################################################################
# Sanity checks on Vault
###############################################################################

- name: Assert required TLS files exist
  stat:
    path: "{{ item }}"
  loop:
     - "{{ vault_ca_cert_path }}"
     - "{{ vault_server_cert_path }}"
     - "{{ vault_server_key_path }}"
     - "{{ vault_client_cert_path_for_consul }}"
     - "{{ vault_client_key_path_for_consul }}"
  register: tls_files
  changed_when: false
  failed_when: not tls_files.stat.exists



