# we expect only 429 (sealed) or 501 (uninitialized) here since Vault is not initialized yet (200 = initialized + unsealed)
- hosts: vault
  become: false
  gather_facts: false
  tasks:
  - name: Verify Vault HTTPS is active (final state)
    uri:
      url: "https://{{ ansible_default_ipv4.address }}:{{ vault_api_port }}/{{ vault_api_health_path }}"
      method: GET
      status_code: [ 429, 501 ]
      # for Ansible to validate the Vault server certificate
      ca_path: "{{ vault_ca_cert_path }}"
      # since we enabled mTLS, Vault will want to check client certs
      # Vault server cert is also a valid client cert for mTLS here
      client_cert: "{{ vault_server_cert_path }}"
      client_key: "{{ vault_server_key_path }}"
      validate_certs: true
      return_content: false
    changed_when: false

- hosts: vault
  become: true
  gather_facts: false
  tasks:
  - name: Mark TLS bootstrap as complete on bastion
    file:
      path: "{{ bastion_tls_dir }}/TLS_BOOTSTRAP_COMPLETE"
      state: touch
      owner: root
      group: root
      mode: "0600"

- hosts: bastion
  become: false
  gather_facts: false
  tasks:
  # verify mTLS from Bastion to Vault and Consul
  - name: Verify Vault HTTPS API from Bastion
    include_role:
      name: verify_https
    vars:
      verify_https_name: "Vault api"
      verify_https_url: "{{ vault_api_addr }}{{ vault_api_health_path }}"
      # mTLS client certs for Bastion → Consul
      verify_https_client_cert: "{{ bastion_client_auth_to_vault_cert_path }}"
      verify_https_client_key: "{{ bastion_client_auth_to_vault_key_path }}"
      # for Ansible to verify Consul server certs signed by our CA
      verify_https_ca_cert: "{{ bastion_ca_cert_path }}"
      verify_https_expected_status: [ 200, 429, 501 ]
  - name: Verify Consul HTTPS API from Bastion
    include_role:
      name: verify_https
    vars:
      verify_https_name: "Consul api"
      verify_https_url: "{{ consul_api_addr }}{{ consul_api_leader_path}}"
      # mTLS client certs for Bastion → Consul
      verify_https_client_cert: "{{ bastion_client_auth_to_consul_cert_path }}"
      verify_https_client_key: "{{ bastion_client_auth_to_consul_key_path }}"
      # for Ansible to verify Consul server certs signed by our CA
      verify_https_ca_cert: "{{ bastion_ca_cert_path }}"
