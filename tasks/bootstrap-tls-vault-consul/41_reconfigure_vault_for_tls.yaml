###############################################################################
# Enable TLS on Vault listener
#
# Preconditions:
#   - Vault is installed, uninitialized, sealed
#   - Vault is currently reachable over HTTP
#   - TLS material has already been distributed:
#       vault_server_cert_path: "{{ vault_tls_dir }}/{{vault_server_cert_file}}"
#       vault_server_key_path: "{{ vault_tls_dir }}/{{vault_server_key_file}}"
#       vault_ca_cert_path: "{{ vault_tls_dir }}/{{ca_cert_file}}"
#
# Guarantees:
#   - Vault API is switched from HTTP â†’ HTTPS
#   - Vault remains reachable after restart
#   - No initialization or unseal is performed yet
###############################################################################

- name: Reconfigure and restart Vault to use TLS
  hosts: vault
  become: true
  gather_facts: false

  ###############################################################################
  # Pre-flight checks (defensive)
  ###############################################################################
  pre_tasks:
  - name: Assert Vault TLS inputs
    include_role:
      name: assert_paths
    vars:
      required_paths:
      - path: "{{ vault_ca_cert_path }}"
        type: file
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: "0644"

      - path: "{{ vault_server_key_path }}"
        type: file
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: "0600"

      - path: "{{ vault_server_cert_path }}"
        type: file
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: "0640"

      - path: "{{ vault_tls_dir }}"
        type: directory
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: "0750"

      - path: "{{ vault_client_auth_to_consul_cert_path }}"
        type: file
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: "0640"

      - path: "{{ vault_client_auth_to_consul_key_path }}"
        type: file
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: "0600"

      - path: "{{ vault_client_auth_to_consul_certs_dir }}"
        owner: "{{ vault_user }}"
        type: directory
        group: "{{ vault_group }}"
        mode: "0750"

  tasks:
  - name: Stop Vault
    systemd:
      name: vault
      state: stopped

  - name: Enable Vault TLS mode
    set_fact:
      vault_tls_enabled: true

  - name: Render Vault config
    template:
      src: vault.hcl.j2
      dest: /etc/vault.d/vault.hcl
      owner: vault
      group: vault
      mode: "0640"

  - name: Start Vault
    systemd:
      name: vault
      state: started

  ###############################################################################
  # Post-flight validation (HTTPS only)
  ###############################################################################
  # 200 should not be possible since Vault is not initialized yet but we allow it here defensively as well
  # 429 (sealed) or 501 (uninitialized) are expected
  - name: Wait for Vault HTTPS health endpoint
    uri:
      url: "https://{{ ansible_default_ipv4.address }}:{{ vault_api_port }}/{{ vault_api_health_path }}"
      method: GET
      status_code: [ 200, 429, 501 ]
      # for Ansible to validate the Vault server certificate
      ca_path: "{{ vault_ca_cert_path }}"
      # since we enabled mTLS, Vault will want to check client certs
      # Vault server cert is also a valid client cert for mTLS here
      client_cert: "{{ vault_server_cert_path }}"
      client_key: "{{ vault_server_key_path }}"
      validate_certs: true
      return_content: false
    register: vault_https_health
    retries: 10
    delay: 3
    until: vault_https_health.status is defined
    changed_when: false
