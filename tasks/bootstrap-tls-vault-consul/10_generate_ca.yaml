---
###############################################################################
# Generate short-lived internal TLS CA on Bastion, distribute to Vault and Consul for client certs validation
#
# Guarantees:
#   - CA private key exists ONLY on Bastion
#   - CA validity is intentionally short-lived 
###############################################################################

- name: Assert bootstrap CA key does not already exist
  stat:
    path: "{{ bastion_ca_key_path }}"
  register: existing_ca_key
  changed_when: false

- name: Fail if bootstrap CA key already exists
  fail:
    msg: >
      Bootstrap CA private key already exists. Refusing to reuse an existing CA.
  when: existing_ca_key.stat.exists

- name: Ensure bootstrap TLS directory exists
  file:
    path: "{{ bastion_tls_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

###############################################################################
# CA private key
###############################################################################

- name: Generate bootstrap TLS CA private key
  community.crypto.openssl_privatekey:
    path: "{{ bastion_ca_key_path }}"
    type: Ed25519
    owner: root
    group: root
    mode: "0600"
  register: bootstrap_ca_key

###############################################################################
# CA certificate (CSR + self-signed cert)
###############################################################################

- name: Generate bootstrap TLS CA CSR
  community.crypto.x509_csr:
    path: "{{ bastion_tls_dir }}/ca.csr"
    privatekey_path: "{{ bastion_ca_key_path }}"
    subject:
      common_name: "vault-consul-bootstrap-tls-ca"
      organization_name: "internal"
    basic_constraints:
      - "CA:TRUE"
    key_usage:
      - keyCertSign
      - cRLSign
    owner: root
    group: root
    mode: "0600"
  register: bootstrap_ca_csr

- name: Generate bootstrap TLS CA certificate (self-signed)
  community.crypto.x509_certificate:
    path: "{{ bastion_ca_cert_path }}"
    csr_path: "{{ bastion_tls_dir }}/ca.csr"
    privatekey_path: "{{ bastion_ca_key_path }}"
    provider: selfsigned
    selfsigned_not_after: "+{{ bootstrap_ca_ttl_days }}d"
    owner: root
    group: root
    mode: "0644"
  register: bootstrap_ca_cert

###############################################################################
# Sanity assertions
###############################################################################

- name: Assert bootstrap CA TTL is within allowed bounds
  assert:
    that:
      - bootstrap_ca_ttl_days | int <= 14
    fail_msg: >
      Bootstrap TLS CA TTL is too long. This CA must be short-lived by design (<= 14 days).

- name: Assert bootstrap CA files exist
  include_role:
    name: assert_paths
  vars:
    required_paths:
      - path: "{{ bastion_ca_key_path }}"
        type: file
        owner: root
        group: root
        mode: "0600"
      - path: "{{ bastion_ca_cert_path }}"
        type: file
        owner: root
        group: root
        mode: "0644"
