# Runs on Bastion, targets Consul API over HTTPS + mTLS
# This task is not idempotent, so it should fail if run more than once. If ACLs are already bootstrapped
# Generate the management token, capture it once, never print it
# Never re-run this step accidentally

# returns JSON that we do not print, do not log, do not write to disk
# only accessible in consul_acl_bootstrap.stdout
#{
#  "AccessorID": "...",
#  "SecretID": "s.xxxxx",
#  "Description": "Bootstrap Token"
#}

# With the token we regain controlled access to the Consul API
# we can create policies and tokens
- hosts: bastion_primary
  become: true
  gather_facts: false
  tasks:
  - name: Bootstrap Consul ACL system
    command: >
      consul acl bootstrap 
      -http-addr={{ consul_api_addr }} 
      -ca-file={{ bastion_ca_cert_path }} 
      -client-cert={{ bastion_client_auth_to_consul_cert_path }} 
      -client-key={{ bastion_client_auth_to_consul_key_path }}
    register: consul_acl_bootstrap
    no_log: true
    changed_when: false
  # we will store here temporarily the management token and consul-vault token in the next playbook, we will remove it at the end of the run
  - name: Ensure Consul ACL token directory exists
    file:
      path: "{{ consul_tokens_tmp_dir }}"
      state: directory
      owner: root
      group: root
      mode: "0700"
  - name: Store Consul management token on bastion
    copy:
      content: "{{ consul_acl_bootstrap.stdout | from_json | json_query('SecretID') }}"
      dest: "{{ consul_tokens_tmp_dir }}/.consul-mgmt-token"
      owner: root
      group: root
      mode: "0600"