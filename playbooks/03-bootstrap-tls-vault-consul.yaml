### Temporary bootstrap of TLS for Vault + Consul + Bastion
### Objective: enable TLS on Vault + Consul after initial setup, before Vault initialization
### Once Vault is initialized, it will issue long-lived TLS certs for itself + Consul

##### On Bastion
# - Generate short-lived bootstrap TLS CA (private key remains on Bastion only, cert is distributed to Vault + Consul)
# - Generate: Vault server key + cert for Vault server authentication to its clients  
# - Generate: Consul server key + cert for Consul server authentication to its clients
# - Generate: Vault client key + cert to authenticate Vault to Consul (Vault → Consul mTLS)
# - Generate: Bastion client key + cert to authenticate Bastion to Consul (Bastion → Consul mTLS)
# - Generate: Bastion client key + cert to authenticate Bastion to Vault (Bastion → Vault mTLS)

##### On Vault
# - Install TLS material generated on Bastion
#   - CA certificate to validate client certs
#   - Vault server certificate + private key
#   - Vault client certificate + private key (for Vault → Consul mTLS)
# - Rewrite Vault config: listener → HTTPS, api_addr → HTTPS
# - Restart Vault

#### On Consul
# Install TLS material generated on Bastion
#   - CA certificate to validate client certs
#   - Consul server certificate + private key
# Rewrite Consul config: HTTP → HTTPS (API), Restart Consul


# Should fail if Vault already has TLS enabled
# The playbook must never be rerun after TLS bootstrap is completed
- name: Pre-flight checks on Vault
  hosts: vault
  gather_facts: false
  become: false

  tasks:
    - name: Health check on Vault http endpoint and initialization status
      block:
        - import_tasks: ../tasks/bootstrap-tls-vault-consul/00_preflight_checks_vault_api.yaml

- name: Pre-flight bootstrap marker check on Bastion
  hosts: bastion
  gather_facts: false
  become: false 
  vars_files:
  - ../vars/bootstrap-tls-vault-consul.yaml
  tasks:
  - name: Check bootstrap marker file exists on Bastion
    block:
      - import_tasks: ../tasks/bootstrap-tls-vault-consul/00_preflight_checks_bastion_marker.yaml

# On Bastion generate:
# CA private key, CA certificate + TTL on
# Vault server certs (per Vault host) on Bastion and distribute to Vault
# Consul server certs (per Consul host) on Bastion and distribute to Consul
# client certs for Vault → Consul mTLS (per Vault host) on Bastion and distribute to Vault
# client certs for Bastion → Consul mTLS (per Bastion host) on Bastion and distribute to Bastion
# client certs for Bastion → Vault mTLS (per Bastion host) on Bastion and distribute to Bastion 
- name: Generate "bootstrap" TLS CA and Vault-Consul-Bastion certs
  hosts: "{{ bastion_primary_host }}"
  connection: local
  gather_facts: false
  become: true
  vars_files:
  - ../vars/bootstrap-tls-vault-consul.yaml
  tasks:

    # CA generation (once)
    - name: Generate bootstrap TLS CA
      import_tasks: ../tasks/bootstrap-tls-vault-consul/10_generate_ca.yaml

    # Vault server cert issuance (per Vault host)
    - name: Issue Vault server TLS certificates
      import_tasks: ../tasks/bootstrap-tls-vault-consul/20_issue_vault_cert.yaml
      loop: "{{ groups['vault'] }}"
      loop_control:
        loop_var: vault_host
        
    # Consul server cert issuance (per Consul host)
    - name: Issue Consul server TLS certificates
      import_tasks: ../tasks/bootstrap-tls-vault-consul/21_issue_consul_cert.yaml
      loop: "{{ groups['consul'] }}"
      loop_control:
        loop_var: consul_host

    # Client cert issuance Vautl --> Consul (per Vault host)
    - name: Issue Vault client TLS certificates (Vault → Consul)
      import_tasks: 22_issue_client_certs.yaml
      loop: "{{ groups['vault'] }}"
      loop_control:
        loop_var: client_host    

    # Client cert issuance Bastion --> Consul (per Bastion host)
    - name: Issue Bastion client TLS certificate (Bastion → Consul)
      import_tasks: 22_issue_certs_for_consul_clients.yaml
      loop: "{{ groups['bastion'] }}"
      loop_control:
        loop_var: client_host

    # Client cert issuance Bastion --> Vault (per Bastion host)
    - name: Issue Bastion client certificate for Vault mTLS
      import_tasks: 23_issue_bastion_vault_client_cert.yaml
      loop: "{{ groups['bastion'] }}"
      loop_control:
        loop_var: bastion_host



# Distribute Vault TLS material from Bastion to Vault
- name: Install Vault TLS material
  hosts: vault
  gather_facts: true
  become: true
  vars_files:
    - ../vars/bootstrap-tls-vault-consul.yaml

  tasks:
    - name: Install Vault TLS material
      import_tasks: ../tasks/bootstrap-tls-vault-consul/30_distribute_tls_vault.yaml

# Distribute Consul TLS material from Bastion to Consul
- name: Install Consul TLS material
  hosts: consul
  gather_facts: true
  become: true
  vars_files:
    - ../vars/bootstrap-tls-vault-consul.yaml

  tasks:
    - name: Install Consul TLS material
      import_tasks: ../tasks/bootstrap-tls-vault-consul/31_distribute_tls_consul.yaml

# Install Bastion client TLS material for Consul mTLS
- name: Install Bastion client TLS material for Consul
  hosts: bastion
  gather_facts: false
  become: true
  vars_files:
    - ../vars/bootstrap-tls-vault-consul.yaml

  tasks:
    - name: Install Bastion client certificate for Consul mTLS
      import_tasks: ../tasks/bootstrap-tls-vault-consul/33_distribute_tls_bastion_client.yaml

# Install Bastion client TLS material for Vault mTLS
- name: Install Bastion client TLS material for Vault
  hosts: bastion
  gather_facts: false
  become: true
  vars_files:
    - ../vars/bootstrap-tls-vault-consul.yaml

  tasks:
    - name: Install Bastion client certificate for Vault mTLS
      import_tasks: ../tasks/bootstrap-tls-vault-consul/34_distribute_tls_bastion_vault_client.yaml

# Reconfigure Vault + Consul to use TLS
- name: Enable TLS in Vault
  hosts: vault
  gather_facts: false
  become: true
  tasks:
    - import_tasks: ../tasks/bootstrap-tls-vault-consul/40_reconfigure_vault_for_tls.yaml


- name: Enable TLS in Consul
  hosts: consul
  gather_facts: false
  become: true
  tasks:
    - import_tasks: ../tasks/bootstrap-tls-vault-consul/41_reconfigure_consul_for_tls.yaml


# HTTPS health check on Vault, mark bootstrap as complete
# CA validation
- name: Verify TLS and record bootstrap completion
  hosts: vault
  gather_facts: false
  become: false

  tasks:
    - name: Verify TLS is active and mark completion
      block:
        - import_tasks: ../tasks/bootstrap-tls-vault-consul/90_verify_and_mark.yaml


# Change Vault API scheme to HTTPS for subsequent plays
# The initial value is defined in group_vars/ as "http"
- name: Persist Vault API scheme as HTTPS for subsequent plays
  set_fact:
    vault_api_scheme: https